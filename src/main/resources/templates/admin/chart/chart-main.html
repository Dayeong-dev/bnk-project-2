<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>관리자 메인</title>
<link rel="stylesheet" th:href="@{/admin/css/header.css}" />
<link rel="stylesheet" th:href="@{/admin/css/sidebar.css}" />
<link rel="stylesheet" th:href="@{/admin/css/base.css}" />
<script th:src="@{/admin/sidebar.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.chart-grid{
  display:grid; grid-template-columns:repeat(2,1fr); gap:24px; padding:24px;
}
.chart-box{
  background:#fff; border:1px solid #ddd; border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.05); padding:20px; position:relative; height:300px;
}
.chart-box canvas{ width:100% !important; height:100% !important; }
.report-actions{ padding:16px 24px 0 24px; display:flex; gap:12px; align-items:center; }
.report-actions input{ height:36px; padding:0 8px; }
.report-actions button{
  padding:8px 16px; border-radius:8px; border:1px solid #ddd; background:#f5f5f5; cursor:pointer;
}
.report-actions button:hover{ background:#e0e0e0; }
</style>
</head>
<body>

  <!-- 공통 헤더 -->
  <div th:replace="admin/fragments/header :: header" class="header"></div>

  <div id="body">
    <!-- 사이드바 -->
    <div th:replace="admin/fragments/sidebar :: sidebar" class="sidebar"></div>

    <!-- 본문 -->
    <div class="content">

      <!-- ✅ 리포트 다운로드 (컨트롤러 경로 /admin/reports 에 맞춤) -->
      <div class="report-actions">
        <input id="reportYear" type="number" min="2000" max="2100" style="width:90px;">
        <input id="reportMonth" type="number" min="1" max="12" style="width:70px;">
        <button id="btn-xlsx" type="button">엑셀 다운</button>
        <button id="btn-pdf"  type="button">PDF 다운</button>
      </div>

      <div class="chart-grid">
        <div class="chart-box"><canvas id="visitChart"></canvas></div>
        <div class="chart-box"><canvas id="productChart"></canvas></div>
        <div class="chart-box"><canvas id="sentimentChart"></canvas></div>
        <div class="chart-box"><canvas id="testResultChart"></canvas></div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function(){
    /* ===== 리포트 버튼: 컨트롤러 경로에 정확히 맞춤 ===== */
    // @RequestMapping("/admin/reports") + @GetMapping("/monthly.xlsx|.pdf")
    const XLSX_BASE = /*[[@{/admin/reports/monthly.xlsx}]]*/ '/admin/reports/monthly.xlsx';
    const PDF_BASE  = /*[[@{/admin/reports/monthly.pdf}]]*/  '/admin/reports/monthly.pdf';

    const $y = document.getElementById('reportYear');
    const $m = document.getElementById('reportMonth');
    const $btnX = document.getElementById('btn-xlsx');
    const $btnP = document.getElementById('btn-pdf');

    // 기본값: 오늘
    const now = new Date();
    $y.value = now.getFullYear();
    $m.value = now.getMonth() + 1;

    function buildUrl(base){
      const y = parseInt($y.value, 10) || now.getFullYear();
      const m = parseInt($m.value, 10) || (now.getMonth()+1);
      return `${base}?year=${encodeURIComponent(y)}&month=${encodeURIComponent(m)}`;
    }

    $btnX.addEventListener('click', ()=> window.open(buildUrl(XLSX_BASE), '_blank'));
    $btnP.addEventListener('click', ()=> window.open(buildUrl(PDF_BASE),  '_blank'));

    /* ===== 차트 (예외 안전) ===== */
    function safe(fn){ try{ fn(); }catch(e){ console.warn(e); } }

    // 방문자 수
    safe(()=> {
      const labels = /*[[${visitLabels}]]*/[];
      const counts = /*[[${visitCounts}]]*/[];
      const ctx = document.getElementById('visitChart').getContext('2d');
      new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'방문자 수', data:counts, backgroundColor:'rgba(47,235,97,0.5)', borderColor:'rgba(47,235,97,1)', borderWidth:1 }] },
        options:{ scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } } }
      });
    });

    // 상품 조회수
    safe(()=> {
      const productLabels = /*[[${labels}]]*/[];
      const productCounts = /*[[${counts}]]*/[];
      const ctx = document.getElementById('productChart').getContext('2d');
      new Chart(ctx, {
        type:'bar',
        data:{ labels:productLabels, datasets:[{ label:'상품별 조회수', data:productCounts, backgroundColor:'rgba(254,80,79,0.5)', borderColor:'rgba(254,80,79,1)', borderWidth:1 }] },
        options:{
          indexAxis:'x', responsive:true,
          scales:{ x:{ beginAtZero:true }, y:{ title:{ display:true, text:'상품명' } } },
          plugins:{ legend:{ display:false }, title:{ display:true, text:'📊 인기 상품 TOP 10 (조회수 기준)' } }
        }
      });
    });

    // 리뷰 감정 통계
    safe(()=> {
      const sentimentLabels = /*[[${sentimentLabels}]]*/[];
      const sentimentCounts = /*[[${sentimentCounts}]]*/[];
      const ctx = document.getElementById('sentimentChart').getContext('2d');
      new Chart(ctx, {
        type:'doughnut',
        data:{ labels:sentimentLabels, datasets:[{ label:'리뷰 감정 통계', data:sentimentCounts,
          backgroundColor:['rgba(254,80,79,0.6)','rgba(60,129,247,0.6)'],
          borderColor:['rgba(254,80,79,1)','rgba(60,129,247,1)'], borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' }, title:{ display:true, text:'👍 리뷰 감정 통계 (긍정 vs 부정)' } } }
      });
    });

    // 소비유형 결과
    safe(()=> {
      const testResultLabels = /*[[${testResultLabels}]]*/[];
      const testResultCounts = /*[[${testResultCounts}]]*/[];
      const ctx = document.getElementById('testResultChart').getContext('2d');
      new Chart(ctx, {
        type:'bar',
        data:{ labels:testResultLabels, datasets:[{ label:'테스트 결과 분포', data:testResultCounts, backgroundColor:'rgba(47,235,97,0.5)', borderColor:'rgba(47,235,97,1)', borderWidth:1 }] },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:'응답 수' }, ticks:{ stepSize:5 } }, x:{ title:{ display:true, text:'테스트 유형' } } },
          plugins:{ legend:{ display:false }, title:{ display:true, text:'🧠 테스트 결과 통계' } }
        }
      });
    });
  });
  </script>
</body>
</html>
