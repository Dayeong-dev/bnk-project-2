<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 메인</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" th:href="@{/admin/css/header.css}" />
    <link rel="stylesheet" th:href="@{/admin/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/admin/css/base.css}" />
    <link rel="stylesheet" th:href="@{/admin/css/adm-layout.css}" />
    <link rel="stylesheet" th:href="@{/admin/css/dashboard.css}" />
</head>
<style>
	:root { --fg:#111; --muted:#666; --border:#e8e8e8; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple SD Gothic Neo, Noto Sans KR, sans-serif; margin: 0; color: var(--fg); background: #fafafa; }
    header { padding: 20px 16px; border-bottom:1px solid var(--border); background:white; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    .hint { color: var(--muted); font-size: 13px; }
    .wrap { padding: 16px; display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); grid-template-rows: 100%; }
    .card { background:white; border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.03);}
    .title { font-weight: 700; margin: 0 0 8px; font-size: 13px; }
    .meta { color: var(--muted); font-size: 10px; margin-bottom: 12px; }
    .row { display:flex; gap:8px; align-items:center; justify-content:space-between; font-size: 13px; color:var(--muted); margin-top:10px; }
    .err { color:#b00020; background:#fff3f3; border:1px solid #ffd6d6; padding:10px; border-radius:8px; }
    .card canvas { width: 50% !important; height: 70% !important; margin: auto; }
    footer { padding: 10px 16px 24px; color: var(--muted); font-size: 12px; }

	.d-flex { display:flex; }
	.w_100p { width : 100% !important; }
	.border_detail { border:1px solid var(--border); border-radius:12px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,.03); padding: 10px; margin: 10px 0; }
	.border_detail2{ border: 1px solid var(--border); border-radius: 12px; background: white; box-shadow: 0 1px 2px rgba(0, 0, 0, .03); padding: 5px 10px 0 10px; }
	.content { min-height: 100vh; }
	.blockLeft { display : block; width : 70% !important; height : 100% !important; }
	.bounceRateDiv { justify-content: space-between;}
	.bounceRatioDetailDiv { width : 33%; height : 100% !important; }
	.bounceRatioCanvas { width : 45%; height : 65%; }
	.enrollTrendDiv { height : 45% !important; }
	.bottomDiv { height: auto !important; justify-content: space-between; gap: 16px; align-items: stretch; }
	.dailyVisitorDiv { width : 45% !important; }

	.reviewDiv { width:25% !important; }
	.reviewDiv.border_detail { padding:14px; }
	.review-wrap { column-gap:16px; align-items:center; width:100%; }
	.review-chart canvas { width:250px !important; height:250px !important; margin: auto; }

	.review-text { display:flex; flex-direction:column; gap:6px; min-width:0; align-items:center; }
	.review-title { font-weight:700; font-size:14px; color:#111; }
	.review-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; font-size:13px; color:#6b7280; }
	.review-list li { display:flex; align-items:center; gap:8px; }
	.review-swatch { width:12px; height:12px; border-radius:3px; display:inline-block; }
	.review-pos { color:#16a34a; font-weight:700; }
	.review-neg { color:#ef4444; font-weight:700; }

	.blockRight {display:block; width:30%; margin-left:10px; height: 100%; }
	.confirmDiv{height:30%!important;}
	.fcmDiv {height:26%!important;}

	.productTop5Card { }
	.productTop5Card h2 { font-size:14px; font-weight:700; color:#111; margin:0 0 8px; }
	#adm-product-top5-canvas { width:100% !important; height:260px !important; display:block; }

	.calendar {width : 30%!important;}
	.calendar-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
	.calendar-header h2 { margin: 0; font-size: 18px; font-weight: bold; }
    .calendar-header button { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; font-weight: bold; color: #999; margin-bottom: 8px; }
  	.calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 4px; }
  	.calendar-days div { width: 38px; height: 38px; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 50%; transition: background 0.3s, color 0.3s;}
  	.calendar-days div:hover { background: #f5f5f5; }
  	.today { background: #ff5722; color: #fff !important; font-weight: bold; }
  	.other-month { color: #ccc; }

  	#pub-fcm { padding: 8px 0 0 0; }
	#pub-fcm .head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-size:14px; }
	#tpl-list { list-style:none; padding:0; margin:0; }
	#tpl-list .tpl-item { padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-bottom:8px; }
	#tpl-list .tpl-title { font-size:12px; font-weight:600; color:#6b7280; }
	#tpl-list .tpl-body { font-size:15px; font-weight:700; line-height:1.5; margin:6px 0 4px; word-break:break-word; }
	#tpl-list .tpl-meta { font-size:12px; color:#6b7280; }
	#tpl-list .tpl-meta span + span::before { content:"·"; margin:0 6px; color:#d1d5db; }

	.adm-kpis .adm-card.kpi { display: flex; flex-direction: column; justify-content: center; gap: 6px; padding: 16px 18px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.04); min-height: 96px; }
	.adm-kpis .kpi-label { font-size: 12px; color: #6b7280; letter-spacing: .2px; }
	.adm-kpis .kpi-value { font-size: 28px; font-weight: 700; line-height: 1; }
	.adm-kpis .kpi-sub   { font-size: 12px; color: #6b7280; display: flex; align-items: center; gap: 6px; }
	.adm-kpis .kpi-sub .trend.up   { color:#16a34a; }
	.adm-kpis .kpi-sub .trend.down { color:#ef4444; }
	.adm-kpis .kpi-sub .trend.flat { color:#6b7280; }

	.review-wrap { align-items:center; gap:14px; padding:12px; }
	.review-chart{ margin: auto; }

	.bounceRatioDetailDiv .bounceRatioCanvas { width:140px; height:140px; margin:0; flex:0 0 auto; }
	.bounceRatioDetailDiv .bounceRatioText { margin:0; display:flex; flex-direction:column; gap:4px; flex:1 1 auto; min-width:0; }
	.bounceRatioText .headline { font-size:13px; font-weight:700; color:#111; }
	.bounceRatioText .headline .drop { color:#ef4444; font-weight:700; }
	.bounceRatioText .headline .step-name { color:#6b7280; font-weight:600; }
	.bounceRatioText .meta { font-size:12px; color:#6b7280; }
	.bounceRatioText .keep { color:#16a34a; font-weight:700; }
</style>

<script>
	var arrDailyVisitorData = [];
	var arrDailyVisitorLabel = [];

	window.onload = function() {
		setDataBounceRatio();
		setDataDailyVisitor();
	}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/admin/sidebar.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<body>
    <!-- 공통 헤더 (주석 처리됨) -->
    <!-- <div th:replace="admin/fragments/header :: header" class="header"></div> -->

    <div id="body" class="adm-layout">
		<!-- 토글 버튼 -->
		<button id="adm-sidebar-toggle" aria-label="사이드바 접기/펼치기" aria-expanded="true" title="메뉴">
		  <span class="bar"></span><span class="bar"></span><span class="bar"></span>
		</button>

		<!-- 사이드바 -->
		<aside class="adm-sidebar">
			<div th:replace="admin/fragments/sidebar :: sidebar" class="sidebar"></div>
		</aside>

        <!-- 본문 -->
        <main class="adm-content">

          <!-- ✅ 리포트 다운로드 바 (여기에 버튼 위치) -->
          <div class="border_detail" style="display:flex; gap:8px; align-items:center; padding:10px; margin: 6px 0 12px;">
            <label for="reportYear" style="font-size:12px; color:#6b7280;">연도</label>
            <input id="reportYear" type="number" min="2000" max="2100" style="width:90px; height:32px; padding:0 8px;">
            <label for="reportMonth" style="font-size:12px; color:#6b7280;">월</label>
            <input id="reportMonth" type="number" min="1" max="12" style="width:70px; height:32px; padding:0 8px;">

            <button id="btn-xlsx" type="button"
                    style="padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#f5f5f5; cursor:pointer;">
              엑셀 다운
            </button>
            <button id="btn-pdf" type="button"
                    style="padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#f5f5f5; cursor:pointer;">
              PDF 다운
            </button>
          </div>

	      <div class="content d-flex w_100p">
	        <div class="blockLeft">
	          <div class="bounceRateDiv d-flex w_100p">
	            <div class="bounceRatioDetailDiv border_detail"><canvas id="bounceRate_1" class="bounceRatioCanvas"></canvas></div>
	            <div class="bounceRatioDetailDiv border_detail"><canvas id="bounceRate_2" class="bounceRatioCanvas"></canvas></div>
	            <div class="bounceRatioDetailDiv border_detail"><canvas id="bounceRate_3" class="bounceRatioCanvas"></canvas></div>
	          </div>

	          <!-- KPI 4개 -->
	          <div class="adm-kpis">
	            <div class="adm-card adm-card--short kpi" id="kpi-today">
	              <div class="kpi-label">금일 방문자 수</div>
	              <div class="kpi-value" id="kpiTodayVisitors">—</div>
	              <div class="kpi-sub" id="kpiTodayVisitorsSub">어제 대비 —</div>
	            </div>

	            <div class="adm-card adm-card--short kpi">
	              <div class="kpi-label">푸시 알림 클릭율</div>
	              <div class="kpi-value"><span id="kpiPushCtr">72</span>%</div>
	              <div class="kpi-sub">최근 캠페인 평균</div>
	            </div>

	            <div class="adm-card adm-card--short kpi">
	              <div class="kpi-label"><span id="kpiEnrollLabel">최근 7일 가입</span></div>
	              <div class="kpi-value" id="kpiEnrollCount">66</div>
	              <div class="kpi-sub" id="kpiEnrollSub">전 기간 대비 —</div>
	            </div>

	            <div class="adm-card adm-card--short kpi">
	              <div class="kpi-label">활성 FCM 템플릿</div>
	              <div class="kpi-value" id="kpiActiveTpl">2</div>
	              <div class="kpi-sub" id="kpiActiveTplSub">자동 발송 설정</div>
	            </div>
	          </div>

	          <div class="enrollTrendDiv border_detail w_100p">
	            <canvas id="enrollLineChart"></canvas>
	          </div>

	          <div class="bottomDiv d-flex w_100p">
	            <div class="dailyVisitorDiv border_detail">
	              <canvas id="dailyVisitorCanvas" class="w_100p"></canvas>
	            </div>

	            <!-- 리뷰 카드 -->
	            <div class="reviewDiv border_detail">
	              <div class="review-wrap">
	                <div class="review-chart">
	                  <canvas id="reviewCanvas"></canvas>
	                </div>
	                <div class="review-text">
	                  <div class="review-title">리뷰 긍정/부정 비율</div>
	                  <ul class="review-list">
	                    <li>
	                      <span class="review-swatch" style="background:#f87171"></span>
	                      긍정 <span id="reviewPosPct" class="review-pos">—%</span>
	                    </li>
	                    <li>
	                      <span class="review-swatch" style="background:#e5e7eb"></span>
	                      부정 <span id="reviewNegPct" class="review-neg">—%</span>
	                    </li>
	                  </ul>
	                </div>
	              </div>
	            </div>

	            <div class="border_detail calendar">
	              <div class="calendar-header">
	                <button id="prev">&#10094;</button>
	                <h2 id="monthYear"></h2>
	                <button id="next">&#10095;</button>
	              </div>
	              <div class="calendar-weekdays">
	                <div>MON</div><div>TUE</div><div>WED</div>
	                <div>THU</div><div>FRI</div><div>SAT</div><div>SUN</div>
	              </div>
	              <div class="calendar-days" id="calendarDays"></div>
	            </div>
	          </div>
	        </div>

	        <div class="blockRight">
	          <div class="border_detail confirmDiv">
	            <h2>결재목록</h2>
	            <div style="margin-top:15px;">
	              <div style="font-size:12px;">2025.08.22 12:22:45</div>
	              <div class="d-flex">
	                <div style="width:15%">반려</div>|
	                <div style="width:15%">관리자</div>|
	                <div style="width:70%">[긴급]부산은행 로고디자인 변경 결재요청</div>
	              </div>
	            </div>
	            <div style="margin-top:15px;">
	              <div style="font-size:12px;">2025.08.14 13:33:14</div>
	              <div class="d-flex">
	                <div style="width:15%">승인</div>|
	                <div style="width:15%">김법진</div>|
	                <div style="width:70%">광복 80주년 기념 특별 이벤트 행사 주최 결재요청</div>
	              </div>
	            </div>
	            <div style="margin-top:15px;">
	              <div style="font-size:12px;">2025.08.25 09:54:</div>
	              <div class="d-flex">
	                <div style="width:15%">대기</div>|
	                <div style="width:15%">김법진</div>|
	                <div style="width:70%">관리자 대시보드 색상 및 디자인 수정요청</div>
	              </div>
	            </div>
	          </div>

	          <div class="border_detail2 fcmDiv">
	            <div id="pub-fcm">
	              <div class="head">
	                <span>활성 템플릿</span>
	                <span id="tpl-count">(0건)</span>
	              </div>
	              <ul id="tpl-list"></ul>
	              <div id="tpl-empty" style="display:none">활성 템플릿이 없습니다.</div>
	            </div>
	          </div>

	          <div class="product_top5"></div>
	        </div>
	      </div>
        </main>
    </div>

<!-- ===== 기존 차트/위젯 스크립트 (네가 준 그대로) ===== -->
<script>
/* 기존 유틸/차트/FCM/달력/지표 스크립트 전부 — 생략 없이 그대로 유지 (네가 올린 코드 내용) */
/* --- 이탈율 데이터 유틸/차트/텍스트 --- */
async function fetchNdjson(url) {
  const res = await fetch(url, { cache: 'no-cache' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  return text.trim().split('\n').filter(Boolean).map(line => JSON.parse(line));
}
async function fetchJsonFlexible(url){
  const res = await fetch(url, {cache:'no-cache'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  try{
    const j = JSON.parse(txt);
    return Array.isArray(j) ? j : [j];
  }catch(_){
    return txt.trim().split('\n').filter(Boolean).map(JSON.parse);
  }
}
const base = 'https://storage.googleapis.com/bnk-analytics-static/charts/step_drop_rates/latest-000000000000.ndjson';
const NDJSON_URL = `${base}?nocache=${Date.now()}`;
async function setDataBounceRatio() {
  try {
    var arrBounceRatio = await fetchNdjson(NDJSON_URL);
    for (var i = 0; i < arrBounceRatio.length; i++) {
      setBounceRatioChart((i + 1), arrBounceRatio[i]);
      setBounceRatioText((i + 1), arrBounceRatio[i]);
    }
  } catch (err) { console.log("err"); }
}
function setBounceRatioChart(idx, arr) {
  var ctx = document.getElementById('bounceRate_' + idx);
  var myChart = new Chart(ctx, {
    type : 'doughnut',
    data : { labels : ['이탈', '유지'],
      datasets : [{ data : [arr["drop_rate_pct"], 100 - arr["drop_rate_pct"]],
        backgroundColor: ['#e5e7eb', '#f87171'], borderWidth: 0, radius: '95%', cutout: '70%', rotation: -90 * Math.PI / 180, borderRadius: 30 }]},
    options : { responsive : false, maintainAspectRatio : false, animation: { duration: 800 } },
    plugins: [baseRingPlugin]
  });
}
const baseRingPlugin = {
  id: 'baseRing',
  beforeDatasetsDraw(chart) {
    const meta = chart.getDatasetMeta(0);
    if (!meta?.data?.length) return;
    const arc = meta.data[0], ctx = chart.ctx;
    ctx.save(); ctx.fillStyle = '#e5e7eb'; ctx.beginPath();
    ctx.arc(arc.x, arc.y, arc.outerRadius, 0, Math.PI * 2);
    ctx.arc(arc.x, arc.y, arc.innerRadius, Math.PI * 2, 0, true);
    ctx.closePath(); ctx.fill(); ctx.restore();
  }
};
function setBounceRatioText(idx, row) {
  const canvas = document.getElementById('bounceRate_' + idx);
  if (!canvas) return;
  const box = canvas.parentElement;
  let wrap = box.querySelector('.bounceRatioText');
  if (!wrap) { wrap = document.createElement('div'); wrap.className = 'bounceRatioText'; box.appendChild(wrap); }
  wrap.textContent = '';
  const stepIndex = String(row.step_index ?? idx);
  const stepName  = String(row.step_name ?? '');
  const dropPct   = Number(row.drop_rate_pct ?? row.value ?? 0);
  const keepPct   = Number(row.conv_rate_pct ?? (100 - dropPct));
  const head = document.createElement('div'); head.className = 'headline';
  const s1 = document.createElement('span'); s1.textContent = `Step ${stepIndex}. `;
  const s2 = document.createElement('span'); s2.className = 'drop'; s2.textContent = `이탈율 ${dropPct.toFixed(1)}%`;
  const s3 = document.createElement('span'); s3.className = 'step-name'; s3.textContent = ` (${stepName})`;
  head.appendChild(s1); head.appendChild(s2); head.appendChild(s3);
  const meta2 = document.createElement('div'); meta2.className = 'meta';
  const keepLabel = document.createElement('span'); keepLabel.textContent = '유지율 ';
  const keepVal = document.createElement('span'); keepVal.className = 'keep'; keepVal.textContent = `${keepPct.toFixed(1)}%`;
  meta2.appendChild(keepLabel); meta2.appendChild(keepVal);
  wrap.appendChild(head); wrap.appendChild(meta2);
}
/* --- 상품가입추세 라인 --- */
var ctx = document.getElementById('enrollLineChart');
var myChart = new Chart(ctx, {
  type : 'line',
  data : { labels : ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
    datasets : [{ label : '상품가입추세', data : [510,200,350,40,500,62,721,822,955,100,111,12],
      fill : true, tension: 0.4, borderColor : '#FF9595', backgroundColor : areaGradient }]},
  options : { responsive : true, maintainAspectRatio : false, devicePixelRatio: 2,
    scales : { x : { grid : { drawOnChartArea: false } }, y : { min : 0, beginAtZero : true, grid : { drawOnChartArea: false } } } }
});
function areaGradient(context) {
  const {chart} = context; const {ctx, chartArea} = chart;
  if (!chartArea) return 'rgba(179,107,255,0)';
  const g = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
  g.addColorStop(0, 'rgba(255,167,167,0.1)'); g.addColorStop(1, 'rgba(255,167,167,0.75)');
  return g;
}
/* --- 일일 방문자 --- */
var dailyBase = "https://storage.googleapis.com/bnk-analytics-bangmun/onedaybangmun";
var dailyUrl = `${dailyBase}?nocache=${Date.now()}`;
async function setDataDailyVisitor() {
  try{
    var arrDailyVisitor = await fetchNdjson(dailyUrl);
    for(var i=0; i<arrDailyVisitor.length; i++) {
      arrDailyVisitorLabel.push(arrDailyVisitor[i]["event_date"]);
      arrDailyVisitorData.push(parseInt(arrDailyVisitor[i]["user_count"]));
    }
  } catch (err) { console.log("err"); }
  setDailyVisitorChart(arrDailyVisitorLabel, arrDailyVisitorData);
}
function setDailyVisitorChart(dailyLabel, dailyData) {
  var ctx2 = document.getElementById('dailyVisitorCanvas');
  var myChart2 = new Chart(ctx2, {
    type : 'bar',
    data : { labels : dailyLabel, datasets : [{ label : '일일방문자수', data : dailyData, backgroundColor:'#FF9595', borderRadius : 10 }]},
    options : { responsive : true, maintainAspectRatio : false, devicePixelRatio: 2,
      scales : { x : { grid : { drawOnChartArea: false} }, y : { beginAtZero : true } } }
  });
}
/* --- 리뷰 도넛 --- */
(function () {
  const canvas = document.getElementById('reviewCanvas');
  const posEl = document.getElementById('reviewPosPct');
  const negEl = document.getElementById('reviewNegPct');
  const POS = 67.1, NEG = 100 - POS, COLORS = ['#f87171', '#e5e7eb'];
  function pickSize() { const w = window.innerWidth; if (w >= 1200) return 220; if (w >= 960) return 200; if (w >= 640) return 180; return 150; }
  let SIZE = pickSize();
  canvas.width = SIZE; canvas.height = SIZE; canvas.style.width = SIZE + 'px'; canvas.style.height = SIZE + 'px';
  const chart = new Chart(canvas, {
    type: 'doughnut',
    data: { labels:['긍정','부정'], datasets:[{ data:[POS,NEG], backgroundColor:COLORS, borderRadius:10, radius:'95%', cutout:'70%' }] },
    options: { responsive:false, maintainAspectRatio:false, rotation:-90, circumference:180, plugins:{ legend:{ display:false } } }
  });
  if (posEl) posEl.textContent = `${POS.toFixed(1)}%`;
  if (negEl) negEl.textContent = `${NEG.toFixed(1)}%`;
  window.addEventListener('resize', () => {
    const s = pickSize();
    if (s !== SIZE) { SIZE = s; canvas.width = SIZE; canvas.height = SIZE; canvas.style.width = SIZE + 'px'; canvas.style.height = SIZE + 'px'; chart.resize(); }
  });
})();
/* --- FCM 목록 --- */
document.addEventListener('DOMContentLoaded', () => {
  const url = '/admin/fcm/templates/active';
  const list = document.getElementById('tpl-list');
  const count = document.getElementById('tpl-count');
  const empty = document.getElementById('tpl-empty');
  fetch(url).then(res => res.json()).then(items => {
    if (!items || items.length === 0) { count.textContent = '(0건)'; empty.style.display = 'block'; return; }
    count.textContent = `(${items.length}건)`;
    list.innerHTML = items.map(t => `
      <li class="tpl-item">
        <div class="tpl-title">BNK Reframe</div>
        <div class="tpl-body">${t.body ?? ''}</div>
        <div class="tpl-meta"><span>[${t.groupCode ?? ''}]</span><span>cron: ${t.cron || '-'}</span></div>
      </li>
    `).join('');
  }).catch(() => { count.textContent = '(0건)'; empty.style.display = 'block'; empty.textContent = '불러오기 실패'; });
});
/* --- 달력/사이드바 --- */
const monthYear = document.getElementById("monthYear");
const calendarDays = document.getElementById("calendarDays");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
let today = new Date(); let currentMonth = today.getMonth(); let currentYear = today.getFullYear();
function renderCalendar(month, year) {
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  monthYear.textContent = `${monthNames[month]}, ${year}`;
  calendarDays.innerHTML = "";
  let firstDay = new Date(year, month, 1).getDay(); if (firstDay === 0) firstDay = 7;
  let daysInMonth = new Date(year, month+1, 0).getDate();
  let prevDays = new Date(year, month, 0).getDate();
  for (let i = firstDay-1; i > 0; i--) { let div = document.createElement("div"); div.classList.add("other-month"); div.textContent = prevDays - i + 1; calendarDays.appendChild(div); }
  for (let i = 1; i <= daysInMonth; i++) { let div = document.createElement("div"); div.textContent = i;
    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) div.classList.add("today"); calendarDays.appendChild(div); }
  let totalCells = (firstDay-1) + daysInMonth; let nextDays = 42 - totalCells;
  for (let i = 1; i <= nextDays; i++) { let div = document.createElement("div"); div.classList.add("other-month"); div.textContent = i; calendarDays.appendChild(div); }
}
prevBtn.addEventListener("click", () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(currentMonth, currentYear); });
nextBtn.addEventListener("click", () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(currentMonth, currentYear); });
renderCalendar(currentMonth, currentYear);
document.addEventListener('DOMContentLoaded', function(){
  const layout = document.querySelector('.adm-layout'); const btn = document.getElementById('adm-sidebar-toggle'); if (!layout || !btn) return;
  const KEY = 'adm.sidebar.collapsed';
  const isCollapsed = localStorage.getItem(KEY) === '1';
  if (isCollapsed) { layout.classList.add('adm-collapsed'); btn.setAttribute('aria-expanded', 'false'); }
  btn.addEventListener('click', () => {
    const collapsedNow = layout.classList.toggle('adm-collapsed');
    btn.setAttribute('aria-expanded', String(!collapsedNow));
    localStorage.setItem(KEY, collapsedNow ? '1' : '0');
  });
});
/* --- 금일 방문자 수 KPI --- */
(function () {
  const SRC = 'https://storage.googleapis.com/bnk-analytics-bangmun/onedaybangmun';
  const $label = document.querySelector('#kpi-today .kpi-label');
  const $value = document.getElementById('kpiTodayVisitors');
  const $sub   = document.getElementById('kpiTodayVisitorsSub');
  const ymd = (d)=>[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('');
  const ymdDot = (d)=>[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('.');
  const today = new Date(), yesterday = new Date(Date.now()-86400000);
  function render(rows){
    const tKey = ymd(today), yKey = ymd(yesterday);
    const tRow = rows.find(r=>String(r.event_date)===tKey);
    const yRow = rows.find(r=>String(r.event_date)===yKey);
    const tCnt = tRow ? (+tRow.user_count||0) : 0;
    const yCnt = yRow ? (+yRow.user_count||0) : 0;
    const diff = tCnt - yCnt;
    if ($label) $label.textContent = `금일 방문자 수 (${ymdDot(today)})`;
    if ($value) $value.textContent = tCnt.toLocaleString();
    if ($sub) {
      $sub.textContent = '';
      const prefix = document.createElement('span'); prefix.textContent = '어제 대비 ';
      const trend = document.createElement('span');
      let dir = 'flat', arrow = '—', body = '—';
      if (diff > 0) { dir = 'up'; arrow = '▲'; body = yCnt > 0 ? `${arrow} ${diff.toLocaleString()} (${((diff/yCnt)*100).toFixed(1)}%)` : `${arrow} ${diff.toLocaleString()}`; }
      else if (diff < 0) { dir = 'down'; arrow = '▼'; const abs = Math.abs(diff); body = yCnt > 0 ? `${arrow} ${abs.toLocaleString()} (${((abs/yCnt)*100).toFixed(1)}%)` : `${arrow} ${abs.toLocaleString()}`; }
      trend.className = 'trend ' + dir; trend.textContent = body;
      $sub.appendChild(prefix); $sub.appendChild(trend);
    }
  }
  window.updateTodayVisitors = render;
  fetch(SRC,{cache:'no-cache'}).then(r=>r.text()).then(t=>{
    let rows; try{ rows = JSON.parse(t); }catch{ rows = t.trim().split('\n').filter(Boolean).map(JSON.parse); }
    render(rows);
  }).catch(()=>{
    if ($label) $label.textContent = '금일 방문자 수';
    if ($value) $value.textContent = '—';
    if ($sub)   $sub.textContent   = '데이터 오류';
  });
})();
/* --- 7일 가입자 수 KPI / 전월 대비 표시 --- */
(function () {
  const $count = document.getElementById('kpiEnrollCount');
  const $sub   = document.getElementById('kpiEnrollSub');
  if (!$count || !$sub) return;
  fetch('/mobile/account/api/stats/signups/7d', { headers: { 'Accept': 'application/json' } })
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(list => {
      if (!Array.isArray(list) || list.length === 0) return;
      const total = list.reduce((sum, it) => sum + (Number(it.count) || 0), 0);
      $count.textContent = String(total);
      const last = Number(list[list.length - 1]?.count) || 0;
      const prev = Number(list[list.length - 2]?.count) || 0;
      $sub.textContent = '';
      const label = document.createElement('span'); label.textContent = '전일 대비 ';
      const trend = document.createElement('span');
      if (prev > 0) {
        const diff = last - prev; const pct  = Math.abs((diff / prev) * 100);
        let dir = 'flat', arrow = '—'; if (diff > 0) { dir = 'up'; arrow = '▲'; } if (diff < 0) { dir = 'down'; arrow = '▼'; }
        trend.className = 'trend ' + dir; trend.textContent = `${arrow} ${Math.abs(diff)} (${pct.toFixed(1)}%)`;
      } else { trend.className = 'trend flat'; trend.textContent = '—'; }
      $sub.appendChild(label); $sub.appendChild(trend);
    })
    .catch(() => {});
})();
(function () {
  const subEl = document.getElementById('kpiEnrollSub');
  if (!subEl) return;
  const STATE = 'up', DIFF = 12, PCT = 18.2;
  subEl.textContent = '';
  const label = document.createElement('span'); label.textContent = '전일 대비 '; subEl.appendChild(label);
  const trend = document.createElement('span'); trend.className = 'trend ' + (STATE === 'up' ? 'up' : STATE === 'down' ? 'down' : 'flat');
  if (STATE === 'flat') { trend.textContent = '—'; }
  else { const arrow = STATE === 'up' ? '▲' : '▼'; trend.textContent = `${arrow} ${Math.abs(DIFF)} (${Math.abs(PCT).toFixed(1)}%)`; }
  subEl.appendChild(trend);
})();
/* --- 푸시 CTR 전월 대비 --- */
(function () {
  const PREV_MONTH_CTR = 65.3;
  const currEl = document.getElementById('kpiPushCtr'); if (!currEl) return;
  const curr = parseFloat((currEl.textContent || '').replace(',', '.')) || 0;
  const card = currEl.closest('.adm-card'); const subEl = card ? card.querySelector('.kpi-sub') : null; if (!subEl) return;
  const diff = curr - PREV_MONTH_CTR; const dir  = diff === 0 ? 'flat' : (diff > 0 ? 'up' : 'down'); const arrow = dir === 'up' ? '▲' : dir === 'down' ? '▼' : '—';
  let body = '—'; if (dir !== 'flat') { if (PREV_MONTH_CTR > 0) { const rel = Math.abs((diff / PREV_MONTH_CTR) * 100); body = `${arrow} ${rel.toFixed(1)}%`; } else { body = `${arrow} ${Math.abs(diff).toFixed(1)}%`; } }
  subEl.textContent = ''; const prefix = document.createElement('span'); prefix.textContent = '전월 대비 ';
  const trend = document.createElement('span'); trend.className = 'trend ' + dir; trend.textContent = body; subEl.appendChild(prefix); subEl.appendChild(trend);
})();
/* --- 상품 조회수 TOP5 --- */
(function(){
  const PRODUCT_TOP5_SRC = 'https://storage.googleapis.com/bnk-analytics-bangmun/topviewproduct';
  const host = document.querySelector('.product_top5'); if (!host) return;
  const card = document.createElement('div'); card.className = 'border_detail productTop5Card';
  const title = document.createElement('h2'); title.textContent = '상품 조회수 TOP 5';
  const canvas = document.createElement('canvas'); canvas.id = 'adm-product-top5-canvas';
  card.appendChild(title); card.appendChild(canvas); host.appendChild(card);
  function toArray(rows){ return rows.map(r => ({ product_id: String(r.product_id ?? r.productId ?? r.id ?? ''), detail_views: Number(r.detail_views ?? r.detailView ?? r.views ?? r.count ?? 0) })).filter(x => x.product_id !== '' && !Number.isNaN(x.detail_views)); }
  function drawChart(top5){
    const labels = top5.map(r => `ID ${r.product_id}`); const data = top5.map(r => r.detail_views);
    new Chart(canvas, { type: 'bar', data: { labels, datasets: [{ label: '상세조회수', data, backgroundColor: '#f87171', borderRadius: 8, barThickness: 20 }]},
      options: { responsive: true, maintainAspectRatio: false, devicePixelRatio: 2, indexAxis: 'y', plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { drawOnChartArea:false } }, y: { grid: { display:false } } } }});
  }
  function showError(msg){ const err = document.createElement('div'); err.className = 'err'; err.textContent = msg || '상품 조회수 데이터를 불러오지 못했습니다.'; card.appendChild(err); }
  fetchJsonFlexible(`${PRODUCT_TOP5_SRC}?nocache=${Date.now()}`)
    .then(rows => { const arr = toArray(rows); if (arr.length === 0) return showError('데이터가 없습니다.'); arr.sort((a,b) => b.detail_views - a.detail_views); drawChart(arr.slice(0,5)); })
    .catch(() => showError());
})();
</script>

<!-- ===== ✅ 리포트 다운로드 핸들러 (dashboard3 경로 사용) ===== -->
<script>
(function(){
  // 여기만 바꾸면 경로 전환 가능
  const XLSX_BASE = 'http://localhost:8090/admin/dashboard3/monthly.xlsx';
  const PDF_BASE  = 'http://localhost:8090/admin/dashboard3/monthly.pdf';

  function byId(id){ return document.getElementById(id); }
  function todayYM(){ const now=new Date(); return { y: now.getFullYear(), m: now.getMonth()+1 }; }
  function buildUrl(base, y, m){ return base + '?year=' + encodeURIComponent(y) + '&month=' + encodeURIComponent(m); }

  const $y   = byId('reportYear');
  const $m   = byId('reportMonth');
  const $btnX = byId('btn-xlsx');
  const $btnP = byId('btn-pdf');

  (function setDefaults(){
    const t=todayYM();
    if ($y && !$y.value) $y.value = t.y;
    if ($m && !$m.value) $m.value = t.m;
  })();

  if ($btnX) $btnX.addEventListener('click', function(){
    const t=todayYM();
    const y = parseInt($y && $y.value,10) || t.y;
    const m = parseInt($m && $m.value,10) || t.m;
    location.href = buildUrl(XLSX_BASE, y, m);
  });

  if ($btnP) $btnP.addEventListener('click', async function(){
    const t=todayYM();
    const y = parseInt($y && $y.value,10) || t.y;
    const m = parseInt($m && $m.value,10) || t.m;

    // 이 페이지에 있는 대표 캔버스 2개를 캡처 (원하면 아이디 추가/변경 가능)
    const ids = ['reviewCanvas', 'dailyVisitorCanvas'];
    const images = {}; let captured = 0;

    for (let i=0;i<ids.length;i++){
      const el = byId(ids[i]);
      if (!el || !el.toDataURL) continue;
      try {
        const b64 = el.toDataURL('image/png').split(',')[1];
        if (b64) { images[ids[i]] = b64; captured++; }
      } catch (e) { console.warn('canvas capture failed:', ids[i], e); }
    }

    if (captured > 0) {
      try {
        const res = await fetch(PDF_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year: y, month: m, images })
        });
        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `월간리포트_${y}-${String(m).padStart(2,'0')}.pdf`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          return;
        }
        console.warn('POST /monthly.pdf failed, fallback to GET. status=', res.status);
      } catch(e) {
        console.warn('POST /monthly.pdf error, fallback to GET.', e);
      }
    } else {
      console.warn('No charts captured, fallback to GET.');
    }
    // GET 폴백
    location.href = buildUrl(PDF_BASE, y, m);
  });
})();
</script>

</body>
</html>
