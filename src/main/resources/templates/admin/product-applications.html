<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>상품 신청 관리</title>

  <!-- 공통 리소스 -->
  <link rel="stylesheet" th:href="@{/admin/css/header.css}" />
  <link rel="stylesheet" th:href="@{/admin/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/admin/css/base.css}" />

  <!-- 페이지 전용 스타일 (pa- 접두사) -->
  <style>
    .pa-page { display:block; }
    .pa-title { font-size:20px; font-weight:700; margin:12px 0 16px; }

    /* 요약지표 */
    .pa-summary { display:grid; grid-template-columns:repeat(4,minmax(140px,1fr)); gap:12px; margin-bottom:16px; }
    .pa-summary-card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; }
    .pa-summary-label { font-size:12px; color:#6b7280; }
    .pa-summary-value { font-size:18px; font-weight:700; margin-top:6px; }

    /* 2컬럼 레이아웃: 좌 50% / 우 50% */
    .pa-layout { display:grid; grid-template-columns:50% 50%; gap:16px; }

    /* 좌측: 상품 목록 */
    .pa-left { background:#fff; border:1px solid #e5e7eb; border-radius:10px; }
    .pa-left-header { padding:12px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between; }
    .pa-left-title { font-weight:600; }
    .pa-left-body { padding:0 12px 12px; }
    .pa-table-wrapper { max-height:45vh; overflow-y:auto; border-radius:8px; border:1px solid #e5e7eb; }
    .pa-table { width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed; background:#fff; }
    .pa-table thead th { position:sticky; top:0; z-index:1; background:#f8fafc; text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    .pa-table tbody td { padding:10px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
    .pa-table tbody tr { cursor:pointer; }
    .pa-table tbody tr:hover { background:#fafafa; }
    .pa-row-active { background:#f0f9ff !important; }
    .pa-col-name { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pa-col-cat { color:#6b7280; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pa-col-counts { font-variant-numeric:tabular-nums; }

    /* 우측: 가입 내역 */
    .pa-right { background:#fff; border:1px solid #e5e7eb; border-radius:10px; display:flex; flex-direction:column; }
    .pa-right-header { padding:12px; border-bottom:1px solid #f1f5f9; display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; align-items:center; }
    .pa-right-title { font-weight:600; }
    .pa-filter { display:flex; gap:8px; flex-wrap:wrap; }
    .pa-filter-btn { border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:8px; font-size:13px; cursor:pointer; }
    .pa-filter-btn:hover { background:#f8fafc; }
    .pa-filter-btn-active { border-color:#2563eb; color:#2563eb; background:#eff6ff; }

    .pa-right-body { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .pa-app-table-wrapper { border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; }
    .pa-app-table { width:100%; border-collapse:collapse; font-size:14px; table-layout:auto; }
    .pa-app-table thead th { position:sticky; top:0; background:#f8fafc; text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; }
    .pa-app-table tbody td { padding:10px; border-bottom:1px solid #f1f5f9; }
    .pa-col-date { white-space:nowrap; }

    .pa-badge { border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block; }
    .pa-badge-progress { background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; }
    .pa-badge-completed { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .pa-badge-canceled { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    .pa-empty { text-align:center; color:#94a3b8; padding:16px; }
  </style>
</head>

<body>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script th:src="@{/admin/sidebar.js}"></script>

  <!-- 공통 헤더 -->
  <div th:replace="~{admin/fragments/header :: header}" class="header"></div>

  <div id="body">
    <!-- 공통 사이드바 -->
    <div th:replace="~{admin/fragments/sidebar :: sidebar}" class="sidebar"></div>

    <!-- 본문 -->
    <div class="content">

      <!-- ✅ 엔드포인트를 /admin/api/* 로 수정 -->
      <div id="pa-page"
           class="pa-page"
           th:data-products-url="@{/admin/api/products}"
           th:data-applications-url="@{/admin/api/products}"
           th:data-summary-url="@{/admin/api/products/summary}">

        <div class="pa-title">상품 신청 관리</div>

        <!-- 요약지표 -->
        <div class="pa-summary" id="pa-summary">
          <div class="pa-summary-card">
            <div class="pa-summary-label">전체 신청</div>
            <div class="pa-summary-value" id="pa-sum-total">-</div>
          </div>
          <div class="pa-summary-card">
            <div class="pa-summary-label">진행</div>
            <div class="pa-summary-value" id="pa-sum-progress">-</div>
          </div>
          <div class="pa-summary-card">
            <div class="pa-summary-label">완료</div>
            <div class="pa-summary-value" id="pa-sum-completed">-</div>
          </div>
          <div class="pa-summary-card">
            <div class="pa-summary-label">취소</div>
            <div class="pa-summary-value" id="pa-sum-canceled">-</div>
          </div>
        </div>

        <!-- 2컬럼 -->
        <div class="pa-layout">

          <!-- 좌측: 상품 목록 -->
          <section class="pa-left">
            <div class="pa-left-header">
              <div class="pa-left-title">상품 목록</div>
            </div>

            <div class="pa-left-body">
              <div class="pa-table-wrapper">
                <table class="pa-table" id="pa-products-table">
                  <thead>
                    <tr>
                      <th style="width:46%;">상품명</th>
                      <th style="width:20%;">카테고리</th>
                      <th style="width:34%;">가입 수 (전체/진행/완료/취소)</th>
                    </tr>
                  </thead>
                  <tbody id="pa-products-tbody"></tbody>
                </table>
              </div>
              <div id="pa-products-empty" class="pa-empty" style="display:none;">상품이 없습니다.</div>
            </div>
          </section>

          <!-- 우측: 가입 내역 -->
          <section class="pa-right">
            <div class="pa-right-header">
              <div class="pa-right-title">가입 내역</div>
              <div class="pa-filter" id="pa-filter">
                <button class="pa-filter-btn pa-filter-btn-active" data-status="ALL">전체</button>
                <button class="pa-filter-btn" data-status="IN_PROGRESS">진행</button>
                <button class="pa-filter-btn" data-status="COMPLETED">완료</button>
                <button class="pa-filter-btn" data-status="CANCELED">취소</button>
              </div>
            </div>

            <div class="pa-right-body">
              <div class="pa-app-table-wrapper">
                <table class="pa-app-table" id="pa-apps-table">
                  <thead>
                    <tr>
                      <th style="width:40%;">가입자</th>
                      <th style="width:40%;">신청일</th>
                      <th style="width:20%;">상태</th>
                    </tr>
                  </thead>
                  <tbody id="pa-apps-tbody"></tbody>
                </table>
              </div>
              <div id="pa-apps-empty" class="pa-empty" style="display:none;">가입 내역이 없습니다.</div>
            </div>
          </section>

        </div>
      </div>
    </div>
  </div>

  <!-- 페이지 전용 스크립트 -->
  <script>
  (function ($) {
    'use strict';

    $(function () {
      var selectedProductId = null;
      var currentStatusFilter = 'ALL';

      var $page = $('#pa-page');
      var productsUrl = $page.data('products-url');        // /admin/api/products
      var appsBaseUrl = $page.data('applications-url');    // /admin/api/products
      var summaryUrl  = $page.data('summary-url');         // /admin/api/product-applications/summary

      // ===== 요약지표 =====
      function fetchSummary() {
        if (!summaryUrl) return;
        $.getJSON(String(summaryUrl), function (m) {
          $('#pa-sum-total').text((m && m.total) || 0);
          $('#pa-sum-progress').text((m && m.progress) || 0);
          $('#pa-sum-completed').text((m && m.completed) || 0);
          $('#pa-sum-canceled').text((m && m.canceled) || 0);
        });
      }

      // ===== 좌측: 상품 목록 =====
      function fetchProducts() {
        $.getJSON(String(productsUrl), function (list) {
          renderProductList(list || []);
          if (!selectedProductId && list && list.length) {
            selectedProductId = String(list[0].productId || list[0].id);
            $('#pa-products-tbody tr[data-product-id="' + selectedProductId + '"]').addClass('pa-row-active');
            fetchApplications(selectedProductId);
          }
        });
      }

      function renderProductList(products) {
        var $tb = $('#pa-products-tbody');
        $tb.empty();

        if (!products.length) {
          $('#pa-products-empty').show();
          return;
        }
        $('#pa-products-empty').hide();

        products.forEach(function (p) {
          var total  = (p.totalCount ?? 0);
          var inProg = (p.inProgressCount ?? p.inProg ?? 0);
          var done   = (p.completedCount ?? p.done ?? 0);
          var cancel = (p.canceledCount ?? p.cancel ?? p.cancelled ?? 0);

          var $tr = $('<tr>').attr('data-product-id', String(p.productId || p.id || ''));
          var $td1 = $('<td>');
          $td1.append($('<div>').addClass('pa-col-name').text(p.name || p.productName || '-'));
          $td1.append($('<div>').addClass('pa-col-cat').text(p.purpose || ''));

          var $td2 = $('<td>').text(p.category || '-');
          var $td3 = $('<td>').addClass('pa-col-counts').text([total, inProg, done, cancel].join('/'));

          $tr.append($td1, $td2, $td3);
          $tb.append($tr);
        });

        if (selectedProductId) {
          $tb.find('tr[data-product-id="' + String(selectedProductId) + '"]').addClass('pa-row-active');
        }
      }

      // 행 클릭 -> 선택/하이라이트/우측 조회
      $(document).on('click', '#pa-products-tbody tr', function () {
        selectedProductId = $(this).attr('data-product-id') || '';
        $('#pa-products-tbody tr').removeClass('pa-row-active');
        $(this).addClass('pa-row-active');
        fetchApplications(selectedProductId);
      });

      // ===== 우측: 가입 내역 =====
      function fetchApplications(productId) {
        if (!productId) { return; }
        // ✅ /admin/api/products/{id}/applications 로 호출
        var url = String(appsBaseUrl).replace(/\/+$/, '') + '/' + encodeURIComponent(productId) + '/applications';
        $.getJSON(url, function (list) {
          renderApplications(list || []);
        });
      }

      function statusToBadge(status) {
        var s = (status || '').toUpperCase();
        var $span = $('<span>').addClass('pa-badge');
        if (s === 'IN_PROGRESS' || s === 'STARTED' || s === 'PROGRESS') {
          $span.addClass('pa-badge-progress').text('진행');
        } else if (s === 'COMPLETED' || s === 'DONE' || s === 'COMPLETE' || s === 'CLOSED') {
          $span.addClass('pa-badge-completed').text('완료');
        } else if (s === 'CANCELED' || s === 'CANCELLED' || s === 'CANCEL' || s === 'CANCLED') {
          $span.addClass('pa-badge-canceled').text('취소');
        } else {
          $span.text('-');
        }
        return $span;
      }

      function renderApplications(apps) {
        var $tb = $('#pa-apps-tbody');
        $tb.empty();

        if (!apps.length) {
          $('#pa-apps-empty').show();
          return;
        }
        $('#pa-apps-empty').hide();

        var f = (currentStatusFilter || 'ALL').toUpperCase();
        var filtered = apps.filter(function (a) {
          if (f === 'ALL') return true;
          var s = (a.status || '').toUpperCase();
          if (f === 'IN_PROGRESS') return (s === 'IN_PROGRESS' || s === 'STARTED' || s === 'PROGRESS');
          if (f === 'COMPLETED')   return (s === 'COMPLETED' || s === 'DONE' || s === 'COMPLETE' || s === 'CLOSED');
          if (f === 'CANCELED')    return (s === 'CANCELED' || s === 'CANCELLED' || s === 'CANCEL' || s === 'CANCLED');
          return true;
        });

        filtered.forEach(function (a) {
          var userName = a.userName || (a.user && (a.user.name || a.user.username)) || '-';
          var startAt  = a.startAt || a.start_at || a.createdAt || '';

          var $tr = $('<tr>');
          $tr.append($('<td>').text(userName));
          $tr.append($('<td>').addClass('pa-col-date').text(startAt));
          $tr.append($('<td>').append(statusToBadge(a.status)));
          $tb.append($tr);
        });
      }

      // 상태 필터 버튼
      $(document).on('click', '.pa-filter-btn', function () {
        $('.pa-filter-btn').removeClass('pa-filter-btn-active');
        $(this).addClass('pa-filter-btn-active');
        currentStatusFilter = $(this).attr('data-status') || 'ALL';
        if (selectedProductId) {
          fetchApplications(selectedProductId);
        }
      });

      // 초기 로딩
      fetchSummary();
      fetchProducts();
    });

  })(jQuery);
  </script>
</body>
</html>
